<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - MuslimVerse</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-green-50">
    <!-- Header -->
    <header class="bg-green-700 text-white shadow-lg sticky top-0 z-20">
        <nav class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="home.html" class="text-xl font-bold flex items-center">
                <span class="mr-2 text-2xl">ðŸ•‹</span>
                <span>MuslimVerse</span>
            </a>
            <a href="home.html" class="text-sm font-semibold hover:bg-green-600 px-3 py-1 rounded-md transition-colors">Home</a>
        </nav>
    </header>

    <!-- Profile Content -->
    <main class="max-w-xl mx-auto p-4 md:p-8 space-y-8">
        <!-- Profile Details Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">My Profile</h2>
            
            <div id="view-mode">
                <div id="profile-emoji" class="text-8xl w-32 h-32 flex items-center justify-center bg-gray-100 rounded-full mx-auto mb-4">ðŸ‘¤</div>
                <h1 id="profile-name" class="text-3xl font-bold text-gray-800 text-center">Loading...</h1>
                <p id="profile-username" class="text-md text-gray-500 text-center mb-4"></p>
                <p id="profile-bio" class="text-gray-600 text-center italic mb-6"></p>

                <!-- NEW: Profile Stats -->
                <div class="flex justify-around text-center border-t border-b py-4 my-4">
                    <div>
                        <p id="post-count" class="text-2xl font-bold">0</p>
                        <p class="text-sm text-gray-500">Posts</p>
                    </div>
                    <div>
                        <p id="friend-count" class="text-2xl font-bold">0</p>
                        <p class="text-sm text-gray-500">Friends</p>
                    </div>
                    <div>
                        <p id="join-date" class="text-lg font-bold">--</p>
                        <p class="text-sm text-gray-500">Joined</p>
                    </div>
                </div>

                <button id="edit-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">Edit Profile</button>
            </div>

            <div id="edit-mode" class="hidden">
                 <label class="font-semibold text-gray-600">Profile Emoji:</label>
                <input id="edit-emoji-input" type="text" class="w-full p-2 border rounded mb-4 text-center text-6xl h-24" maxlength="2">
                
                <label class="font-semibold text-gray-600">Full Name:</label>
                <input id="edit-name-input" type="text" class="w-full p-2 border rounded mb-2">

                <label class="font-semibold text-gray-600">About Me (Bio):</label>
                <textarea id="edit-bio-input" class="w-full p-2 border rounded mb-2" placeholder="Write a short bio..."></textarea>
                
                <label class="font-semibold text-gray-600">Location:</label>
                <input id="edit-location-input" type="text" class="w-full p-2 border rounded mb-2" placeholder="e.g., Dhaka, Bangladesh">
                
                <label class="font-semibold text-gray-600">Interests:</label>
                <input id="edit-interests-input" type="text" class="w-full p-2 border rounded mb-2" placeholder="e.g., Fiqh, Islamic History">

                <label class="font-semibold text-gray-600">Favorite Surah:</label>
                <input id="edit-surah-input" type="text" class="w-full p-2 border rounded mb-4" placeholder="e.g., Surah Al-Fatiha">

                <div class="flex space-x-4">
                    <button id="save-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700">Save Changes</button>
                    <button id="cancel-btn" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Social Management Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Social Hub</h2>
            <!-- Incoming Friend Requests -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Incoming Friend Requests</h3>
                <div id="friend-requests-container" class="space-y-3"></div>
            </div>
             <!-- My Friends -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">My Friends</h3>
                <div id="my-friends-container" class="space-y-3"></div>
            </div>
             <!-- Sent Requests -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Sent Requests</h3>
                <div id="sent-requests-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- My Posts Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Posts</h2>
            <div id="my-posts-feed" class="space-y-4"></div>
        </div>

        <!-- Logout Section -->
        <div class="text-center">
            <button id="logout-btn" class="w-full max-w-sm bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700">Logout</button>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD3VEv_rdd3FElJupOnfGrBQuLjGwACsA8",
            authDomain: "masklink-calling.firebaseapp.com",
            databaseURL: "https://masklink-calling-default-rtdb.firebaseio.com",
            projectId: "masklink-calling",
            storageBucket: "masklink-calling.appspot.com",
            messagingSenderId: "240213769733",
            appId: "1:240213769733:web:53e35fbf17e4b4d284266c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUserId = null;
        let currentUserProfile = {};

        // Get all DOM elements
        const viewMode = document.getElementById('view-mode');
        const editMode = document.getElementById('edit-mode');
        const profileEmoji = document.getElementById('profile-emoji');
        const profileName = document.getElementById('profile-name');
        const profileUsername = document.getElementById('profile-username');
        const profileBio = document.getElementById('profile-bio');
        const postCountEl = document.getElementById('post-count');
        const friendCountEl = document.getElementById('friend-count');
        const joinDateEl = document.getElementById('join-date');
        const editEmojiInput = document.getElementById('edit-emoji-input');
        const editNameInput = document.getElementById('edit-name-input');
        const editBioInput = document.getElementById('edit-bio-input');
        const editLocationInput = document.getElementById('edit-location-input');
        const editInterestsInput = document.getElementById('edit-interests-input');
        const editSurahInput = document.getElementById('edit-surah-input');
        const friendRequestsContainer = document.getElementById('friend-requests-container');
        const myFriendsContainer = document.getElementById('my-friends-container');
        const sentRequestsContainer = document.getElementById('sent-requests-container');
        const myPostsFeed = document.getElementById('my-posts-feed');

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loadUserProfile(user);
                loadFriendRequests();
                loadMyFriends();
                loadSentRequests();
                loadMyPosts();
            } else {
                window.location.href = "login.html";
            }
        });

        function loadUserProfile(user) {
            db.ref('userProfiles/' + currentUserId).on('value', snapshot => {
                if (snapshot.exists()) {
                    currentUserProfile = snapshot.val();
                    // Update View Mode
                    profileEmoji.textContent = currentUserProfile.profileEmoji || 'ðŸ‘¤';
                    profileName.textContent = currentUserProfile.fullName || 'Anonymous User';
                    profileUsername.textContent = `@${currentUserProfile.username}` || '';
                    profileBio.textContent = currentUserProfile.bio || 'No bio yet.';
                    
                    // Update Stats
                    joinDateEl.textContent = new Date(user.metadata.creationTime).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    db.ref('friends/' + currentUserId).once('value', snap => friendCountEl.textContent = snap.numChildren());
                    db.ref('posts').orderByChild('uid').equalTo(currentUserId).once('value', snap => postCountEl.textContent = snap.numChildren());
                    
                    // Pre-fill Edit Mode
                    editEmojiInput.value = currentUserProfile.profileEmoji || 'ðŸ‘¤';
                    editNameInput.value = currentUserProfile.fullName || '';
                    editBioInput.value = currentUserProfile.bio || '';
                    editLocationInput.value = currentUserProfile.location || '';
                    editInterestsInput.value = currentUserProfile.interests || '';
                    editSurahInput.value = currentUserProfile.favoriteSurah || '';
                }
            });
        }
        
        function toggleEditMode(isEditing) {
            viewMode.classList.toggle('hidden', isEditing);
            editMode.classList.toggle('hidden', !isEditing);
        }

        function saveProfileChanges() {
            const updates = {
                fullName: editNameInput.value.trim(),
                profileEmoji: editEmojiInput.value.trim() || 'ðŸ‘¤',
                bio: editBioInput.value.trim(),
                location: editLocationInput.value.trim(),
                interests: editInterestsInput.value.trim(),
                favoriteSurah: editSurahInput.value.trim()
            };

            db.ref('userProfiles/' + currentUserId).update(updates).then(() => {
                alert("Profile updated successfully!");
                toggleEditMode(false);
            }).catch(error => alert("Error: " + error.message));
        }

        function loadFriendRequests() { /* ... Same as before ... */ }
        function loadMyFriends() {
            db.ref(`friends/${currentUserId}`).on('value', snapshot => {
                myFriendsContainer.innerHTML = '';
                if (!snapshot.exists()) {
                    myFriendsContainer.innerHTML = '<p class="text-gray-500">You have no friends yet.</p>';
                    return;
                }
                snapshot.forEach(friendSnap => {
                    const friendId = friendSnap.key;
                    db.ref(`userProfiles/${friendId}`).once('value', profileSnap => {
                        const friend = profileSnap.val();
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                        friendDiv.innerHTML = `
                             <a href="view_profile.html?uid=${friendId}" class="flex items-center">
                                <div class="text-3xl w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full mr-3">${friend.profileEmoji || 'ðŸ‘¤'}</div>
                                <span class="font-semibold">${friend.fullName || 'User'}</span>
                            </a>
                            <button onclick="unfriend('${friendId}')" class="bg-red-500 text-white text-xs px-2 py-1 rounded-md hover:bg-red-600">Unfriend</button>
                        `;
                        myFriendsContainer.appendChild(friendDiv);
                    });
                });
            });
        }
        
        function loadSentRequests() {
            db.ref('friendRequests').on('value', snapshot => {
                sentRequestsContainer.innerHTML = '';
                let found = false;
                snapshot.forEach(receiverSnap => {
                    if (receiverSnap.hasChild(currentUserId)) {
                        found = true;
                        const receiverId = receiverSnap.key;
                        db.ref(`userProfiles/${receiverId}`).once('value', profileSnap => {
                             const user = profileSnap.val();
                             const reqDiv = document.createElement('div');
                             reqDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                             reqDiv.innerHTML = `
                                <a href="view_profile.html?uid=${receiverId}" class="flex items-center">
                                    <div class="text-3xl w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full mr-3">${user.profileEmoji || 'ðŸ‘¤'}</div>
                                    <span class="font-semibold">${user.fullName || 'User'}</span>
                                </a>
                                <button onclick="cancelFriendRequest('${receiverId}')" class="bg-yellow-500 text-white text-xs px-2 py-1 rounded-md hover:bg-yellow-600">Cancel</button>
                            `;
                             sentRequestsContainer.appendChild(reqDiv);
                        });
                    }
                });
                if (!found) {
                    sentRequestsContainer.innerHTML = '<p class="text-gray-500">You have no pending sent requests.</p>';
                }
            });
        }
        
        function loadMyPosts() {
            db.ref('posts').orderByChild('uid').equalTo(currentUserId).on('value', snapshot => {
                myPostsFeed.innerHTML = '';
                if (!snapshot.exists()) {
                    myPostsFeed.innerHTML = '<p class="text-gray-500 text-center">You have not made any posts yet.</p>';
                    return;
                }
                const posts = [];
                snapshot.forEach(child => posts.push({ key: child.key, ...child.val() }));
                posts.reverse().forEach(post => {
                    const postEl = document.createElement("div");
                    postEl.className = "bg-gray-50 border p-4 rounded-lg";
                    postEl.innerHTML = `
                        <p class="text-gray-500 text-xs mb-2">${new Date(post.timestamp).toLocaleString()}</p>
                        <p class="whitespace-pre-wrap">${post.text}</p>
                        ${post.image ? `<img src="${post.image}" class="mt-2 rounded max-h-96 object-contain w-full" />` : ""}
                    `;
                    myPostsFeed.appendChild(postEl);
                });
            });
        }

        // --- All Friend Management Functions ---
        function acceptFriendRequest(senderId) { /* ... Same ... */ }
        function declineFriendRequest(senderId) { /* ... Same ... */ }
        function cancelFriendRequest(receiverId) {
            db.ref(`friendRequests/${receiverId}/${currentUserId}`).remove().then(() => alert("Request cancelled."));
        }
        function unfriend(friendId) {
            if (confirm("Are you sure you want to unfriend this user?")) {
                db.ref(`friends/${currentUserId}/${friendId}`).remove();
                db.ref(`friends/${friendId}/${currentUserId}`).remove();
            }
        }
        function logout() { /* ... Same ... */ }
        
        // --- Event Listeners ---
        document.getElementById('edit-btn').addEventListener('click', () => toggleEditMode(true));
        document.getElementById('cancel-btn').addEventListener('click', () => toggleEditMode(false));
        document.getElementById('save-btn').addEventListener('click', saveProfileChanges);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // NOTE: Please copy the full function bodies for placeholder comments like /* ... Same ... */
    </script>
</body>
</html>
