<!DOCTYPE html>
<html lang="bn" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MuslimVerse ‚Äì Home</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <style>
    body { scroll-padding-top: 70px; }
    .reaction-btn { cursor: pointer; font-weight: 600; padding: 6px 10px; border-radius: 8px; user-select: none; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; gap: 6px; }
    .reaction-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .reaction-selected { background-color: #a7f3d0; }
    .post-menu { position: relative; display: inline-block; }
    .post-menu-content { display: none; position: absolute; right: 0; background-color: #f9f9f9; min-width: 100px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 6px; }
    .post-menu-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
    .post-menu-content a:hover { background-color: #f1f1f1; }
    .post-menu:hover .post-menu-content { display: block; }
    .report-btn-reported { background-color: #fecaca; color: #991b1b; font-weight: bold; }

    /* Modal Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 30; display: none; justify-content: center; align-items: center; }

    /* Floating Menu Styles */
    .floating-menu-container { position: fixed; top: 80px; right: 20px; z-index: 25; display: flex; flex-direction: column; align-items: center; gap: 14px; }
    .floating-btn { width: 56px; height: 56px; background-color: #059669; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; border: none; text-decoration: none; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .floating-btn:hover { background-color: #047857; }
    .floating-menu-toggle { cursor: grab; }
    .floating-menu-item { transform: scale(0); opacity: 0; visibility: hidden; position: absolute; }
    .floating-menu-container.active .floating-menu-item { transform: scale(1); opacity: 1; visibility: visible; position: relative; }

    /* Animation Styles */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { display: inline-block; border: 4px solid rgba(0,0,0,0.1); border-left-color: #059669; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    .blinking-icon { animation: blink 1.5s infinite; border-radius: 50%; }
    @keyframes blink { 0% { background-color: #fca5a5; } 50% { background-color: #bbf7d0; } 100% { background-color: #fca5a5; } }
    .ringing-bell { animation: ring-animation 1.5s infinite; }
    @keyframes ring-animation { 0%, 100% { transform: rotate(0); } 10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); } 20%, 40%, 60%, 80% { transform: rotate(10deg); } }

    /* Feed Toggle Buttons */
    .feed-toggle-btn { transition: all 0.2s ease-in-out; border: 2px solid #059669; }
    .feed-toggle-btn.active { background-color: #059669; color: white; }
    .feed-toggle-btn:not(.active) { background-color: white; color: #059669; }
    
    /* "See More..." CSS */
    .post-text-wrapper { position: relative; overflow: hidden; transition: max-height 0.5s ease-out; }
    .post-text-wrapper.collapsed { max-height: calc(100vh / 5); }
    .see-more-btn { position: absolute; bottom: 0; right: 0; background: linear-gradient(to top, white, rgba(255, 255, 255, 0)); padding: 10px 10px 5px 30px; cursor: pointer; color: #059669; font-weight: bold; display: none; }
    .post-text-wrapper.collapsed .see-more-btn { display: block; }
    
    /* Pull to Refresh CSS */
    #pull-to-refresh-indicator { position: fixed; top: 0; left: 0; right: 0; text-align: center; transform: translateY(-100%); transition: transform 0.3s; z-index: 9; padding-top: 75px; padding-bottom: 10px; }
    #pull-to-refresh-indicator.visible { transform: translateY(0); }
    .loading-container { display: flex; justify-content: center; align-items: center; padding: 2.5rem; }

    /* Video Embed CSS */
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin-top: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    /* Donation Popup Style */
    #donation-popup-overlay { z-index: 50; }
    
    /* Donation Tooltip CSS */
    #donate-tooltip { visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateY(10px); pointer-events: none; }
    #donate-tooltip.visible { visibility: visible; opacity: 1; transform: translateY(0); }
    #donate-tooltip::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 75%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent #fbbf24 transparent;
    }
  </style>
</head>
<body class="bg-green-50 min-h-screen text-gray-800">

  <!-- Donation Login Popup -->
  <div id="donation-popup-overlay" class="modal-overlay">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md relative text-center mx-4">
          <button id="close-popup-btn" class="absolute top-2 right-3 text-3xl text-gray-400 hover:text-gray-800">√ó</button>
          <div id="popup-content-wrapper" class="cursor-pointer">
              <p class="text-xl mb-4 font-serif">ü§≤ ‚Äú‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡¶∞ ‡¶∞‡¶æ‡¶∏‡ßç‡¶§‡¶æ‡ßü ‡¶¨‡ßç‡¶Ø‡ßü ‡¶ï‡¶∞‡ßá, ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤ ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶®‡•§‚Äù</p>
              <p class="text-md font-semibold mb-4 text-gray-700">üìñ ‚Äì ‡¶Ü‡¶≤-‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® (‡ß®:‡ß®‡ß¨‡ßß)</p>
              <p class="text-gray-800 my-5">MuslimVerse ‡¶è‡¶ï‡¶ü‡¶ø ‡¶π‡¶æ‡¶≤‡¶æ‡¶≤, ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶ì ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ ‡¶ï‡¶Æ‡¶ø‡¶â‡¶®‡¶ø‡¶ü‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá ‚Äî ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡ßã‡¶ü ‡¶°‡ßã‡¶®‡ßá‡¶∂‡¶® ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶¨‡¶ø‡¶∂‡¶æ‡¶≤ ‡¶∏‡¶æ‡¶ì‡ßü‡¶æ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡•§</p>
              <p class="text-green-700 font-bold text-lg mt-4 animate-pulse">üéÅ ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶ú‡¶æ‡¶∞‡¶ø‡ßü‡¶æ‡¶π ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶ú‡¶á ‡¶Ö‡¶Ç‡¶∂ ‡¶®‡¶ø‡¶®‡•§</p>
          </div>
      </div>
  </div>

  <!-- Pull to Refresh Indicator -->
  <div id="pull-to-refresh-indicator"><div class="spinner"></div></div>

  <!-- Header -->
  <header class="bg-green-700 text-white shadow-lg sticky top-0 z-20">
    <nav class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="home.html" class="text-xl font-bold flex items-center">
            <span class="mr-2 text-2xl">üïã</span>
            <span>MuslimVerse</span>
        </a>
        <div class="flex items-center space-x-2 md:space-x-3 relative">
            <a href="requests.html" id="friend-requests-btn" title="Friend Requests" class="p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
            </a>
            
            <a href="donation.html" title="‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" class="text-sm bg-green-500 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-green-600 flex items-center gap-1.5 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 5a3 3 0 015.242-2.243l1.264 1.263a.5.5 0 00.707 0l1.264-1.263A3 3 0 0115 5v2.75a.75.75 0 01-1.5 0V5a1.5 1.5 0 00-1.5-1.5h-.035l-1.263 1.263a.5.5 0 01-.707 0L8.535 3.5H8.5A1.5 1.5 0 007 5v2.75a.75.75 0 01-1.5 0V5z" clip-rule="evenodd" /><path d="M4.5 9.5a.5.5 0 00-.5.5v5a.5.5 0 00.5.5h11a.5.5 0 00.5-.5v-5a.5.5 0 00-.5-.5h-11zM10 10.25a.75.75 0 01.75.75v.01a.75.75 0 01-1.5 0v-.01a.75.75 0 01.75-.75zM10 12a.75.75 0 01.75.75v.01a.75.75 0 01-1.5 0v-.01a.75.75 0 01.75-.75z" /></svg>
                <span class="hidden md:inline">‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
            </a>
            
            <span id="donate-tooltip" class="absolute top-full mt-3 right-10 md:right-20 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-md shadow-lg">‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>

            <button onclick="checkNotifications()" id="notification-btn" class="p-2 relative" title="Notifications">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                <span id="notification-dot" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-green-700" style="display: none;"></span>
            </button>
        </div>
    </nav>
  </header>

  <!-- Feed Toggle UI -->
  <div class="max-w-xl mx-auto p-4 flex justify-center space-x-2 bg-green-100 sticky top-[68px] z-10">
    <button id="btn-public-feed" onclick="switchFeedMode('public')" class="feed-toggle-btn active w-1/3 py-2 rounded-md font-semibold">üåç Public</button>
    <button id="btn-friends-feed" onclick="switchFeedMode('friends')" class="feed-toggle-btn w-1/3 py-2 rounded-md font-semibold">üë• Friends</button>
    <button id="btn-video-feed" onclick="switchFeedMode('video')" class="feed-toggle-btn w-1/3 py-2 rounded-md font-semibold flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
        Videos
    </button>
  </div>

  <!-- Main Content -->
  <main class="max-w-xl mx-auto pt-4">
    <div id="feed" class="space-y-4 px-2 pb-4"></div>
    <div id="load-more-container" class="text-center p-4"></div>
  </main>
  
  <!-- All Modals: Post, Search, Share, Notification, Edit -->
    <div id="post-modal-overlay" class="modal-overlay" onclick="toggleModal('post-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('post-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üì¢ What's on your mind?</h2>
          <textarea id="postText" placeholder="Write something Islamic or share a video link..." class="w-full p-2 border border-gray-300 rounded mb-2"></textarea>
          <input id="postImage" type="text" placeholder="Optional Image URL" class="w-full p-2 border border-gray-300 rounded mb-2" />
          <button onclick="createPost()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">Post Now</button>
      </div>
  </div>
  <div id="search-modal-overlay" class="modal-overlay" onclick="toggleModal('search-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('search-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üîç Find Friends</h2>
          <div class="flex space-x-2 mb-4">
            <input id="searchInput" type="text" placeholder="Enter username..." class="w-full p-2 border border-gray-300 rounded">
            <button onclick="searchUsers()" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded font-semibold">Search</button>
          </div>
          <div id="search-results-container" class="max-h-64 overflow-y-auto"></div>
      </div>
  </div>
  <div id="share-modal-overlay" class="modal-overlay" onclick="toggleModal('share-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('share-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üîÑ Share Post</h2>
          <textarea id="shareText" placeholder="Add your comment..." class="w-full p-2 border border-gray-300 rounded mb-3"></textarea>
          <div class="mb-4 border-l-4 border-gray-200 pl-3 py-2">
            <h3 class="font-semibold text-sm text-gray-600 mb-2">Original Post:</h3>
            <div id="original-post-preview"></div>
          </div>
          <button onclick="executeShare()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">Share Now</button>
      </div>
  </div>
  <div id="notification-modal-overlay" class="modal-overlay" onclick="toggleNotificationModal(false)">
      <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md" onclick="event.stopPropagation()">
          <div class="bg-green-600 text-white p-4 rounded-t-lg flex justify-between items-center">
              <h2 class="text-xl font-semibold">üîî Notifications</h2>
              <button onclick="toggleNotificationModal(false)" class="text-2xl leading-none">√ó</button>
          </div>
          <div id="notification-modal-content" class="p-6 text-gray-700 max-h-80 overflow-y-auto"></div>
          <div class="bg-gray-100 p-3 rounded-b-lg text-right">
              <button onclick="toggleNotificationModal(false)" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-md">Close</button>
          </div>
      </div>
  </div>
  <div id="edit-post-modal-overlay" class="modal-overlay" onclick="toggleModal('edit-post-modal-overlay', true)">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
        <button onclick="toggleModal('edit-post-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
        <h2 class="text-xl font-semibold mb-4 text-green-700">‚úçÔ∏è Edit Your Post</h2>
        <textarea id="editPostText" placeholder="Edit your post..." class="w-full p-2 border border-gray-300 rounded mb-2 h-32"></textarea>
        <input id="editPostImage" type="text" placeholder="Edit image URL" class="w-full p-2 border border-gray-300 rounded mb-3" />
        <button onclick="executeUpdate()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">
          Save Changes
        </button>
    </div>
  </div>

  <!-- Floating Menu Container -->
  <div id="floating-menu-container" class="floating-menu-container">
      <button onclick="toggleActionMenu()" class="floating-btn floating-menu-toggle" title="Menu">
          <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <button onclick="toggleModal('post-modal-overlay')" class="floating-btn floating-menu-item" title="Create Post" style="font-size: 28px;">+</button>
      <a href="message.html" class="floating-btn floating-menu-item" title="Messages" style="font-size: 24px;">üí¨</a>
      <a href="requests.html" class="floating-btn floating-menu-item" title="Social Hub">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
      </a>
      <button onclick="toggleModal('search-modal-overlay')" class="floating-btn floating-menu-item" title="Search Users">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
      </button>
      <a href="profile.html" class="floating-btn floating-menu-item" title="My Profile">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
      </a>
      <a href="settings.html" class="floating-btn floating-menu-item" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
      </a>
  </div>

  <!-- New Friend Request & Message Popups -->
  <div id="friend-request-popup" style="position: fixed; bottom: 85px; right: 20px; background-color: #059669; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; display: none; align-items: center;" onclick="this.style.display='none'; location.href='requests.html'">
      <svg xmlns="http://www.w3.org/2000/svg" class="ringing-bell" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px; margin-right: 10px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
      <span>New Friend Request</span>
  </div>
  <div id="message-popup" style="position: fixed; bottom: 20px; right: 20px; background-color: #059669; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; display: none; align-items: center;" onclick="location.href='message.html'">
      <svg xmlns="http://www.w3.org/2000/svg" class="ringing-bell" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px; margin-right: 10px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
      <span>New Message</span>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyD3VEv_rdd3FElJupOnfGrBQuLjGwACsA8",
        authDomain: "masklink-calling.firebaseapp.com",
        databaseURL: "https://masklink-calling-default-rtdb.firebaseio.com",
        projectId: "masklink-calling",
        storageBucket: "masklink-calling.appspot.com",
        messagingSenderId: "240213769733",
        appId: "1:240213769733:web:53e35fbf17e4b4d284266c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Global Variables
    let currentUserId = null;
    let currentUserProfile = {};
    let postsData = {};
    let hasDragged = false;
    let lastLoadedPostTimestamp = null;
    let isLoading = false;
    const POSTS_PER_PAGE = 10;
    let postToShareId = null;
    let currentFeedMode = 'public';
    let friendsList = [];
    let initialRequestsLoaded = false;
    let previousRequestCount = 0;
    let editingPostId = null; 
    let isRefreshing = false;
    const loadingSpinnerHtml = `<div class="loading-container"><div class="spinner"></div></div>`;

    // --- Main Logic ---
    auth.onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; } 
      else {
          currentUserId = user.uid;
          db.ref('userProfiles/' + currentUserId).once('value').then(snap => {
              currentUserProfile = snap.val() || { fullName: user.email, profileEmoji: 'üë§', username: null };
          });
          
          loadFriendsList().then(() => { loadPosts(true); });
          listenForNotifications();
          listenForFriendRequests();
          listenForUnreadMessages(currentUserId);
          makeMenuDraggable();
          initPullToRefresh();
          animateDonateTooltip();

          if (sessionStorage.getItem('justLoggedIn') === 'true') {
              const popupOverlay = document.getElementById('donation-popup-overlay');
              const closeBtn = document.getElementById('close-popup-btn');
              const popupContent = document.getElementById('popup-content-wrapper');
              if(popupOverlay) popupOverlay.style.display = 'flex';
              if(closeBtn) closeBtn.onclick = (e) => { e.stopPropagation(); popupOverlay.style.display = 'none'; };
              if(popupContent) popupContent.onclick = () => { window.location.href = 'donation.html'; };
              sessionStorage.removeItem('justLoggedIn');
          }
      }
    });
    
    // --- Feature Functions ---
    function animateDonateTooltip() {
        const tooltip = document.getElementById('donate-tooltip');
        if (!tooltip) return;
        setInterval(() => {
            tooltip.classList.add('visible');
            setTimeout(() => { tooltip.classList.remove('visible'); }, 4000);
        }, 15000);
    }

    function switchFeedMode(mode) {
        if (isLoading || currentFeedMode === mode) return;
        currentFeedMode = mode;
        document.getElementById('btn-public-feed').classList.toggle('active', mode === 'public');
        document.getElementById('btn-friends-feed').classList.toggle('active', mode === 'friends');
        document.getElementById('btn-video-feed').classList.toggle('active', mode === 'video');
        loadPosts(true);
    }
    
    function loadPosts(isInitialLoad = false) {
        if (isLoading) return;
        isLoading = true;
        const feed = document.getElementById("feed");
        const loadMoreContainer = document.getElementById("load-more-container");

        if (isInitialLoad) {
            feed.innerHTML = loadingSpinnerHtml;
            postsData = {}; lastLoadedPostTimestamp = null; loadMoreContainer.innerHTML = "";
        } else {
            loadMoreContainer.innerHTML = loadingSpinnerHtml;
        }

        let query = db.ref("posts").orderByChild("timestamp");
        if (lastLoadedPostTimestamp) { query = query.endAt(lastLoadedPostTimestamp - 1).limitToLast(POSTS_PER_PAGE); } 
        else { query = query.limitToLast(POSTS_PER_PAGE); }
        
        query.once("value", snapshot => {
            if (isInitialLoad) { feed.innerHTML = ""; }
            loadMoreContainer.innerHTML = "";

            if (!snapshot.exists()) {
                if (isInitialLoad || feed.innerHTML === "") { feed.innerHTML = `<p class="text-center text-gray-500 py-10">No posts found in the ${currentFeedMode} feed.</p>`; } 
                else { loadMoreContainer.innerHTML = '<p class="text-gray-500">You have reached the end.</p>'; }
                isLoading = false; if (isRefreshing) resetPullToRefresh(); return;
            }
            
            const posts = [];
            snapshot.forEach(child => { 
                const post = { key: child.key, ...child.val() }; 
                if (!postsData[post.key]) { posts.unshift(post); postsData[post.key] = post; } 
            });

            if (posts.length > 0) { lastLoadedPostTimestamp = posts[posts.length - 1].timestamp; }

            let filteredPosts;
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const facebookRegex = /(?:https?:\/\/)?(?:www\.)?facebook\.com\/(?:[a-zA-Z0-9.]+\/videos\/|watch\/\?v=|video\.php\?v=)(\d{10,})/;
            if (currentFeedMode === 'friends') {
                filteredPosts = posts.filter(post => friendsList.includes(post.uid) || post.uid === currentUserId);
            } else if (currentFeedMode === 'video') {
                filteredPosts = posts.filter(post => post.text && (youtubeRegex.test(post.text) || facebookRegex.test(post.text)));
            } else {
                filteredPosts = posts;
            }

            if (filteredPosts.length === 0 && snapshot.numChildren() > 0 && !isInitialLoad) {
                isLoading = false; loadPosts(false); return;
            }
            
            if (isInitialLoad && filteredPosts.length === 0) {
                 feed.innerHTML = `<p class="text-center text-gray-500 py-10">No posts found in the ${currentFeedMode} feed.</p>`;
            }

            filteredPosts.forEach(post => {
                if (!post.authorUsername) return;
                const postEl = document.createElement("div"); 
                postEl.id = `post-${post.key}`; postEl.className = "bg-white p-4 rounded-lg shadow";
                const time = new Date(post.timestamp).toLocaleString();
                let menuHtml = (post.uid === currentUserId) ? `<div class="post-menu float-right relative"><span class="text-gray-500 cursor-pointer text-lg">‚ãÆ</span><div class="post-menu-content"><a onclick="openEditModal('${post.key}')">Edit</a><a onclick="deletePost('${post.key}')">Delete</a></div></div>` : '';
                let warningBannerHtml = (post.reportCount >= 5) ? `<div class="p-2 my-3 bg-red-100 border-l-4 border-red-500 text-red-700"><p class="font-bold">Warning:</p><p>This post is under review.</p></div>` : '';
                const postContentHtml = embedVideoPlayer(post.text || "");
                let originalPostHtml = '';
                if (post.originalPost) {
                    originalPostHtml = `<div class="mt-4 border-l-4 border-green-200 pl-3 pt-2 pb-3"><div class="flex items-center mb-2"><div class="text-2xl w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full mr-2">${post.originalPost.authorEmoji || 'üë§'}</div><div><a href="view_profile.html?uid=${post.originalPost.uid}" class="text-sm text-green-700 font-bold hover:underline">${post.originalPost.authorName || 'Anonymous'}</a></div></div><p class="text-gray-700 text-sm whitespace-pre-wrap original-post-text-p">${post.originalPost.text}</p>${post.originalPost.image ? `<img src="${post.originalPost.image}" class="mt-2 rounded max-h-80 object-contain w-full" />` : ""}</div>`;
                }
                postEl.innerHTML = `<div class="flex justify-between items-start"><div class="flex items-center mb-3"><div class="text-4xl w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full mr-3">${post.authorEmoji || 'üë§'}</div><div><a href="view_profile.html?uid=${post.uid}" class="text-md text-green-700 font-bold hover:underline">${post.authorName || 'Anonymous'}</a><p class="text-xs text-gray-500">${time}</p></div></div>${menuHtml}</div>${warningBannerHtml}<div class="text-gray-800 mt-1 whitespace-pre-wrap post-text">${postContentHtml}</div>${post.image ? `<img src="${post.image}" class="mt-2 rounded max-h-96 object-contain w-full post-image" />` : ""}${originalPostHtml}<div id="reactions-${post.key}" class="flex justify-around items-center mt-4 pt-3 text-sm border-t"><button id="btnBarakallah-${post.key}" class="reaction-btn text-red-600"><span>‚ù§Ô∏è</span><span>BarakAllah (0)</span></button><button id="btnSubhanallah-${post.key}" class="reaction-btn text-yellow-600"><span>üåü</span><span>SubhanAllah (0)</span></button><button id="btnAmeen-${post.key}" class="reaction-btn text-green-600"><span>üôå</span><span>Ameen (0)</span></button></div><div class="border-t mt-3 pt-3 flex justify-between items-center"><button id="toggle-comments-btn-${post.key}" onclick="toggleCommentSection('${post.key}')" class="text-sm font-semibold text-gray-600 hover:text-green-700">üí¨ Comments (${post.commentCount || 0})</button><button onclick="openShareModal('${post.key}')" class="text-sm font-semibold text-gray-600 hover:text-green-700">üîÑ Share</button><button id="report-btn-${post.key}" onclick="toggleReportPost('${post.key}', '${post.uid}')" class="reaction-btn text-xs bg-red-50 hover:bg-red-100 text-red-700">Report (0)</button></div><div id="comment-section-wrapper-${post.key}" data-loaded="false" class="mt-3" style="display: none;"><div id="comments-container-${post.key}" class="space-y-2 mb-3 max-h-40 overflow-y-auto"></div><div class="flex space-x-2"><input id="comment-input-${post.key}" type="text" placeholder="Write a comment..." class="w-full p-2 border border-gray-300 rounded"><button onclick="addComment('${post.key}', '${post.uid}')" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded font-semibold">Send</button></div></div>`;
                feed.appendChild(postEl);
                manageSeeMore(postEl);
                if (post.originalPost) { manageOriginalPostSeeMore(postEl); }
                attachReactionListeners(post.key); 
                setupReportButton(post.key);
                db.ref(`posts/${post.key}/commentCount`).on('value', snap => { const btn = document.getElementById(`toggle-comments-btn-${post.key}`); if(btn) btn.textContent = `üí¨ Comments (${snap.val() || 0})`; });
            });

            if (posts.length >= POSTS_PER_PAGE && filteredPosts.length > 0) { 
                const loadMoreBtn = document.createElement('button'); 
                loadMoreBtn.textContent = 'Load More'; 
                loadMoreBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full'; 
                loadMoreBtn.onclick = () => loadPosts(false);
                loadMoreContainer.appendChild(loadMoreBtn); 
            } else {
                if (!isInitialLoad && filteredPosts.length > 0) { loadMoreContainer.innerHTML = '<p class="text-gray-500">You have reached the end.</p>'; }
            }
            isLoading = false; 
            if (isRefreshing) resetPullToRefresh();
        });
    }

    function openEditModal(postId) {
        editingPostId = postId;
        const postToEdit = postsData[postId];
        if (!postToEdit || postToEdit.uid !== currentUserId) {
            alert("Error: Post not found or you don't have permission.");
            return;
        }
        document.getElementById('editPostText').value = postToEdit.text || '';
        document.getElementById('editPostImage').value = postToEdit.image || '';
        toggleModal('edit-post-modal-overlay');
    }

    function executeUpdate() {
        if (!editingPostId) return;
        const newText = document.getElementById('editPostText').value.trim();
        const newImage = document.getElementById('editPostImage').value.trim();
        if (newText === "" && newImage === "") {
            alert("Post cannot be empty.");
            return;
        }
        db.ref('posts/' + editingPostId).update({
            text: newText,
            image: newImage || null
        }).then(() => {
            toggleModal('edit-post-modal-overlay');
            loadPosts(true);
            editingPostId = null;
        }).catch(error => {
            alert("Error updating post: " + error.message);
        });
    }

    function embedVideoPlayer(text) {
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
        const facebookRegex = /(?:https?:\/\/)?(?:www\.)?facebook\.com\/(?:[a-zA-Z0-9.]+\/videos\/|watch\/\?v=|video\.php\?v=)(\d{10,})/g;
        let processedText = text;
        const textOnly = processedText.replace(youtubeRegex, '').replace(facebookRegex, '').trim();
        let videoHtml = '';
        let ytMatch;
        while ((ytMatch = youtubeRegex.exec(text)) !== null) {
            videoHtml += `<div class="video-container"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}?rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
        }
        let fbMatch;
        while ((fbMatch = facebookRegex.exec(text)) !== null) {
            videoHtml += `<div class="video-container"><iframe src="https://www.facebook.com/plugins/video.php?href=https%3A%2F%2Fwww.facebook.com%2Fvideos%2F${fbMatch[1]}%2F&show_text=0&width=560" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share" allowfullscreen="true"></iframe></div>`;
        }
        return `${textOnly} ${videoHtml}`;
    }

    function manageSeeMore(postElement) {
        const postTextElement = postElement.querySelector('.post-text');
        if (!postTextElement) return;
        const textWrapper = document.createElement('div');
        textWrapper.className = 'post-text-wrapper';
        postTextElement.parentNode.insertBefore(textWrapper, postTextElement);
        textWrapper.appendChild(postTextElement);
        const seeMoreButton = document.createElement('span');
        seeMoreButton.className = 'see-more-btn';
        seeMoreButton.innerText = 'See more...';
        textWrapper.appendChild(seeMoreButton);
        if (textWrapper.scrollHeight > window.innerHeight / 5) { textWrapper.classList.add('collapsed'); } 
        else { seeMoreButton.style.display = 'none'; }
        seeMoreButton.addEventListener('click', (event) => {
            event.stopPropagation();
            textWrapper.classList.remove('collapsed');
            textWrapper.style.maxHeight = textWrapper.scrollHeight + 'px';
            seeMoreButton.style.display = 'none';
        });
        textWrapper.addEventListener('dblclick', () => {
            if (!textWrapper.classList.contains('collapsed')) {
                textWrapper.classList.add('collapsed');
                textWrapper.style.removeProperty('max-height');
                seeMoreButton.style.display = 'block';
            }
        });
    }

    function manageOriginalPostSeeMore(postElement) {
        const originalPostTextElement = postElement.querySelector('.original-post-text-p');
        if (!originalPostTextElement) return;
        const textWrapper = document.createElement('div');
        textWrapper.className = 'post-text-wrapper';
        originalPostTextElement.parentNode.insertBefore(textWrapper, originalPostTextElement);
        textWrapper.appendChild(originalPostTextElement);
        const seeMoreButton = document.createElement('span');
        seeMoreButton.className = 'see-more-btn';
        seeMoreButton.innerText = 'See more...';
        textWrapper.appendChild(seeMoreButton);
        if (textWrapper.scrollHeight > window.innerHeight / 6) { textWrapper.classList.add('collapsed'); textWrapper.style.maxHeight = (window.innerHeight / 6) + 'px'; } 
        else { seeMoreButton.style.display = 'none'; }
        seeMoreButton.addEventListener('click', (event) => {
            event.stopPropagation();
            textWrapper.classList.remove('collapsed');
            textWrapper.style.maxHeight = originalPostTextElement.scrollHeight + 'px';
            seeMoreButton.style.display = 'none';
        });
    }

    function initPullToRefresh() {
        let touchStartY = 0;
        const refreshThreshold = 80;
        const indicator = document.getElementById('pull-to-refresh-indicator');
        document.addEventListener('touchstart', e => {
            if (window.scrollY === 0 && !isRefreshing) { touchStartY = e.touches[0].clientY; } 
            else { touchStartY = 0; }
        }, { passive: true });
        document.addEventListener('touchmove', e => {
            if (touchStartY === 0 || isRefreshing) return;
            const pullDistance = e.touches[0].clientY - touchStartY;
            if (pullDistance > 0) { e.preventDefault(); indicator.classList.add('visible'); }
        }, { passive: false });
        document.addEventListener('touchend', e => {
            if (touchStartY === 0 || isRefreshing) return;
            const pullDistance = e.changedTouches[0].clientY - touchStartY;
            if (pullDistance > refreshThreshold) {
                isRefreshing = true;
                indicator.classList.add('visible');
                loadPosts(true);
            } else {
                indicator.classList.remove('visible');
            }
            touchStartY = 0;
        });
    }

    function resetPullToRefresh() {
        const indicator = document.getElementById('pull-to-refresh-indicator');
        if (indicator) { indicator.classList.remove('visible'); }
        isRefreshing = false;
    }

    async function loadFriendsList() {
        friendsList = [];
        const snapshot = await db.ref(`friends/${currentUserId}`).once('value');
        if (snapshot.exists()) { snapshot.forEach(child => { friendsList.push(child.key); }); }
    }

    function showNewMessagePopup() {
        const popup = document.getElementById('message-popup');
        if (popup) { popup.style.display = 'flex'; }
    }

    function listenForUnreadMessages(userId) {
        const userChatsRef = db.ref(`userChats/${userId}`);
        let initialDataLoaded = false; let previousTotalUnread = 0;
        userChatsRef.on('value', snapshot => {
            let totalUnread = 0;
            if (snapshot.exists()) { snapshot.forEach(chatSnapshot => { totalUnread += chatSnapshot.val().unreadCount || 0; }); }
            if (initialDataLoaded && totalUnread > previousTotalUnread) { showNewMessagePopup(); }
            previousTotalUnread = totalUnread;
            if (!initialDataLoaded) { initialDataLoaded = true; }
        });
    }

    function makeMenuDraggable() {
        const menuContainer = document.getElementById('floating-menu-container');
        const dragHandle = document.querySelector('.floating-menu-toggle');
        let isDragging = false, startY, initialTop;
        function dragStart(e) {
            if (e.target !== dragHandle && !dragHandle.contains(e.target)) return;
            e.preventDefault(); hasDragged = false; isDragging = true;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            initialTop = menuContainer.offsetTop;
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove, { passive: false });
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            dragHandle.style.cursor = 'grabbing';
        }
        function dragMove(e) {
            if (!isDragging) return;
            e.preventDefault(); hasDragged = true;
            const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            let newTop = initialTop + (currentY - startY);
            const topBoundary = 80;
            const bottomBoundary = window.innerHeight / 2.5;
            if (newTop < topBoundary) newTop = topBoundary;
            if (newTop > bottomBoundary) newTop = bottomBoundary;
            menuContainer.style.top = newTop + 'px';
        }
        function dragEnd() {
            isDragging = false;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchend', dragEnd);
            dragHandle.style.cursor = 'grab';
        }
        dragHandle.addEventListener('mousedown', dragStart);
        dragHandle.addEventListener('touchstart', dragStart, { passive: true });
    }
    
    function toggleActionMenu() {
        if (hasDragged) { hasDragged = false; return; }
        const menuContainer = document.getElementById('floating-menu-container');
        const menuPosition = menuContainer.getBoundingClientRect();
        menuContainer.style.flexDirection = (menuPosition.top > window.innerHeight / 2) ? 'column-reverse' : 'column';
        menuContainer.classList.toggle('active');
        document.getElementById('menu-icon').classList.toggle('hidden');
        document.getElementById('close-icon').classList.toggle('hidden');
    }

    function toggleModal(modalId, closeByOverlay = false) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const isVisible = modal.style.display === 'flex';
        if ((closeByOverlay && event.target === modal) || !closeByOverlay) {
             modal.style.display = isVisible ? 'none' : 'flex';
        }
    }
    
    function toggleNotificationModal(show) {
        const modal = document.getElementById('notification-modal-overlay');
        if (modal) { modal.style.display = show ? 'flex' : 'none'; }
    }

    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const resultsContainer = document.getElementById('search-results-container');
        resultsContainer.innerHTML = '<p class="text-center text-gray-500">Searching...</p>';
        if (!searchTerm) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">Please enter a username.</p>'; return; }
        db.ref('usernames/' + searchTerm).once('value', usernameSnapshot => {
            if (!usernameSnapshot.exists()) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">No user found.</p>'; return; }
            const uid = usernameSnapshot.val().uid;
            if (uid === currentUserId) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">You cannot search for yourself.</p>'; return; }
            db.ref('userProfiles/' + uid).once('value', profileSnapshot => {
                resultsContainer.innerHTML = '';
                const user = profileSnapshot.val();
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center justify-between p-2 my-1 bg-gray-50 rounded-lg';
                userDiv.innerHTML = `<a href="view_profile.html?uid=${uid}" class="flex items-center"><div class="text-3xl w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full mr-3">${user.profileEmoji || 'üë§'}</div><div><span class="font-semibold">${user.fullName || 'Anonymous'}</span><p class="text-xs text-gray-500">@${user.username}</p></div></a><button onclick="sendFriendRequest(this, '${uid}')" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-md hover:bg-blue-600">Add Friend</button>`;
                resultsContainer.appendChild(userDiv);
            });
        });
    }

    function sendFriendRequest(buttonElement, receiverId) {
        db.ref(`friendRequests/${receiverId}/${currentUserId}`).set({ fromName: currentUserProfile.fullName, fromEmoji: currentUserProfile.profileEmoji, timestamp: firebase.database.ServerValue.TIMESTAMP });
        if(buttonElement){
            buttonElement.textContent = 'Request Sent'; buttonElement.disabled = true;
            buttonElement.className = 'bg-gray-400 text-white text-sm px-3 py-1 rounded-md cursor-not-allowed';
        }
    }

    function createPost() {
        const text = document.getElementById("postText").value.trim();
        const image = document.getElementById("postImage").value.trim();
        if (!text && !image) { alert("Write something or add an image URL first!"); return; }
        if (!currentUserProfile.username) { alert("Your profile is still loading..."); return; }
        const postData = { text, image, uid: currentUserId, authorName: currentUserProfile.fullName, authorEmoji: currentUserProfile.profileEmoji, authorUsername: currentUserProfile.username, timestamp: firebase.database.ServerValue.TIMESTAMP, reportCount: 0, commentCount: 0 };
        const newPostKey = db.ref().child('posts').push().key;
        const updates = {};
        updates['/posts/' + newPostKey] = postData;
        updates['/reactions/' + newPostKey] = { barakallah: 0, subhanallah: 0, ameen: 0 };
        db.ref().update(updates).then(() => {
            document.getElementById("postText").value = ""; document.getElementById("postImage").value = "";
            toggleModal('post-modal-overlay'); loadPosts(true); 
        });
    }
    
    function deletePost(postId, isAutoDelete = false) {
        const post = postsData[postId];
        if (!isAutoDelete && post.uid !== currentUserId) { alert("You can only delete your own posts."); return; }
        const confirmation = isAutoDelete ? true : confirm("Are you sure you want to delete this post?");
        if (confirmation) {
            db.ref('posts/' + postId).remove(); db.ref('reactions/' + postId).remove();
            db.ref('userReactions/' + postId).remove(); db.ref('comments/' + postId).remove();
            db.ref('userReports/' + postId).remove();
            const postElement = document.getElementById(`post-${postId}`);
            if(postElement) postElement.remove();
        }
    }
    
    function openShareModal(postId) {
        postToShareId = postId;
        const post = postsData[postId]; if (!post) return;
        const previewContainer = document.getElementById('original-post-preview');
        previewContainer.innerHTML = `<div class="flex items-center mb-2"><div class="text-2xl w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full mr-2">${post.authorEmoji || 'üë§'}</div><span class="font-semibold text-gray-800">${post.authorName || 'Anonymous'}</span></div><p class="text-gray-600 text-sm whitespace-pre-wrap">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>${post.image ? `<img src="${post.image}" class="mt-2 rounded max-h-24 object-contain w-full" />` : ""}`;
        toggleModal('share-modal-overlay');
    }

    function executeShare() {
        const shareText = document.getElementById('shareText').value.trim();
        const originalPost = postsData[postToShareId];
        if (!shareText) { alert("Please add your comment before sharing."); return; }
        if (!originalPost) { alert("Error: Original post not found."); return; }
        const postData = {
            text: shareText, uid: currentUserId, authorName: currentUserProfile.fullName, authorEmoji: currentUserProfile.profileEmoji,
            authorUsername: currentUserProfile.username, timestamp: firebase.database.ServerValue.TIMESTAMP, reportCount: 0, commentCount: 0,
            originalPost: {
                key: originalPost.key, text: originalPost.text, image: originalPost.image || null, uid: originalPost.uid,
                authorName: originalPost.authorName, authorEmoji: originalPost.authorEmoji, authorUsername: originalPost.authorUsername
            }
        };
        const newPostKey = db.ref().child('posts').push().key;
        const updates = {};
        updates['/posts/' + newPostKey] = postData;
        updates['/reactions/' + newPostKey] = { barakallah: 0, subhanallah: 0, ameen: 0 };
        db.ref().update(updates).then(() => {
            document.getElementById("shareText").value = ""; toggleModal('share-modal-overlay');
            loadPosts(true); sendNotification(originalPost.uid, `${currentUserProfile.fullName} shared your post.`);
        });
    }

    function sendNotification(targetUserId, message) {
        if (targetUserId === currentUserId) return;
        db.ref('notifications/' + targetUserId).push({ message, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false });
    }
    
    function listenForNotifications() {
        const notificationsRef = db.ref('notifications/' + currentUserId);
        notificationsRef.orderByChild('read').equalTo(false).on('value', snapshot => {
            document.getElementById('notification-dot').style.display = snapshot.exists() ? 'block' : 'none';
        });
    }
    
    function showNewFriendPopup() {
        const popup = document.getElementById('friend-request-popup');
        if (popup) { popup.style.display = 'flex'; }
    }

    function listenForFriendRequests() {
        const requestsRef = db.ref(`friendRequests/${currentUserId}`);
        const friendRequestsBtn = document.getElementById('friend-requests-btn');
        if (!friendRequestsBtn) return;
        requestsRef.on('value', snapshot => {
            const currentRequestCount = snapshot.numChildren();
            friendRequestsBtn.classList.toggle('blinking-icon', currentRequestCount > 0);
            if (initialRequestsLoaded && currentRequestCount > previousRequestCount) { showNewFriendPopup(); }
            previousRequestCount = currentRequestCount;
            if (!initialRequestsLoaded) { initialRequestsLoaded = true; }
        });
    }

    function checkNotifications() {
        const notificationsRef = db.ref('notifications/' + currentUserId).orderByChild('timestamp').limitToLast(20);
        const modalContent = document.getElementById('notification-modal-content');
        notificationsRef.once('value').then(snapshot => {
            if (!snapshot.exists()) { modalContent.innerHTML = '<p class="text-center">You have no new notifications.</p>'; } 
            else {
                let messagesHtml = '<ul>';
                const updates = {};
                const notifications = [];
                snapshot.forEach(child => { notifications.unshift({key: child.key, ...child.val()}) });

                notifications.forEach(notification => {
                    messagesHtml += `<li class="border-l-2 ${notification.read ? 'border-gray-200' : 'border-green-400 font-semibold'} pl-2 mb-2">${notification.message}</li>`;
                    if(!notification.read) { updates[notification.key + "/read"] = true; }
                });
                messagesHtml += '</ul>';
                modalContent.innerHTML = messagesHtml;
                if(Object.keys(updates).length > 0) db.ref('notifications/' + currentUserId).update(updates);
            }
            toggleNotificationModal(true);
        });
    }

    function toggleReportPost(postId, authorId) {
        const reportBtn = document.getElementById(`report-btn-${postId}`);
        if (reportBtn.disabled) return; reportBtn.disabled = true;
        const userReportRef = db.ref(`userReports/${postId}/${currentUserId}`);
        const postReportCountRef = db.ref(`posts/${postId}/reportCount`);
        userReportRef.once('value').then(snapshot => {
            if (snapshot.exists()) {
                postReportCountRef.transaction(c => (c && c > 0) ? c - 1 : 0);
                userReportRef.remove().finally(() => reportBtn.disabled = false);
            } else {
                userReportRef.set(true).then(() => {
                    postReportCountRef.transaction((c) => (c || 0) + 1, (err, committed, snap) => {
                        if (committed) {
                            const newCount = snap.val();
                            if (newCount === 5) sendNotification(authorId, "Warning: Your post has 5 reports.");
                            else if (newCount >= 10) { sendNotification(authorId, `Your post was auto-deleted after receiving ${newCount} reports.`); deletePost(postId, true); }
                        }
                        reportBtn.disabled = false;
                    });
                });
            }
        });
    }

    function addComment(postId, postAuthorId) {
        const text = document.getElementById(`comment-input-${postId}`).value.trim();
        if (!text) return;
        const commentData = { text, uid: currentUserId, authorName: currentUserProfile.fullName, authorEmoji: currentUserProfile.profileEmoji, timestamp: firebase.database.ServerValue.TIMESTAMP };
        db.ref('comments/' + postId).push(commentData).then(() => {
            document.getElementById(`comment-input-${postId}`).value = "";
            sendNotification(postAuthorId, `${currentUserProfile.fullName} commented on your post.`);
            db.ref(`posts/${postId}/commentCount`).transaction(count => (count || 0) + 1);
        });
    }

    function editComment(postId, commentId) {
        const commentRef = db.ref(`comments/${postId}/${commentId}`);
        commentRef.once('value', snapshot => {
            const comment = snapshot.val();
            if (!comment || comment.uid !== currentUserId) { alert("You can only edit your own comments."); return; }
            const newText = prompt("Edit your comment:", comment.text);
            if (newText !== null && newText.trim() !== "") {
                commentRef.update({ text: newText.trim() }).catch(err => alert("Error editing comment: " + err.message));
            }
        });
    }
    
    function deleteComment(postId, commentId) {
        const postAuthorId = postsData[postId]?.uid;
        if (!postAuthorId) { alert("Error: Post not found."); return; }
        db.ref(`comments/${postId}/${commentId}`).once('value', commentSnap => {
            const comment = commentSnap.val(); if (!comment) return;
            if (comment.uid === currentUserId || postAuthorId === currentUserId) {
                 if (confirm("Are you sure you want to delete this comment?")) {
                    db.ref(`comments/${postId}/${commentId}`).remove().then(() => {
                        db.ref(`posts/${postId}/commentCount`).transaction(count => (count && count > 0) ? count - 1 : 0);
                    }).catch(err => alert("Error deleting comment: " + err.message));
                 }
            } else { alert("You don't have permission to delete this comment."); }
        });
    }
    
    function addReaction(postId, reactionType) {
        const buttons = [ document.getElementById(`btnBarakallah-${postId}`), document.getElementById(`btnSubhanallah-${postId}`), document.getElementById(`btnAmeen-${postId}`) ];
        if (buttons.some(b => b && b.disabled)) return;
        buttons.forEach(b => { if (b) b.disabled = true; });
        const userReactionRef = db.ref(`userReactions/${postId}/${currentUserId}`), reactionsRef = db.ref(`reactions/${postId}`);
        userReactionRef.once('value').then(snapshot => {
            const previousReaction = snapshot.val(), updates = {};
            if (previousReaction === reactionType) {
                userReactionRef.remove();
                reactionsRef.child(reactionType).transaction(c => (c || 1) - 1).finally(() => buttons.forEach(b => b.disabled=false));
            } else {
                if (previousReaction) updates[`reactions/${postId}/${previousReaction}`] = firebase.database.ServerValue.increment(-1);
                updates[`reactions/${postId}/${reactionType}`] = firebase.database.ServerValue.increment(1);
                updates[`userReactions/${postId}/${currentUserId}`] = reactionType;
                db.ref().update(updates).then(() => {
                    db.ref(`posts/${postId}/uid`).once('value', authorSnap => sendNotification(authorSnap.val(), `${currentUserProfile.fullName} reacted to your post.`));
                }).finally(() => buttons.forEach(b => b.disabled=false));
            }
        });
    }
    
    function loadComments(postId) {
        const commentsContainer = document.getElementById(`comments-container-${postId}`); 
        if (!commentsContainer) return;
        const postAuthorId = postsData[postId]?.uid;
        commentsContainer.innerHTML = '<p class="text-sm text-gray-500">Loading comments...</p>';
        const commentsRef = db.ref('comments/' + postId).orderByChild('timestamp');
        commentsRef.on('value', snapshot => {
            if (!commentsContainer) return; 
            commentsContainer.innerHTML = "";
            if(!snapshot.exists()) { 
                commentsContainer.innerHTML = '<p class="text-sm text-gray-500">Be the first to comment!</p>'; 
            }
            snapshot.forEach(childSnapshot => {
                const comment = childSnapshot.val();
                const commentId = childSnapshot.key;
                const commentEl = document.createElement('div');
                commentEl.id = `comment-${commentId}`; 
                commentEl.className = "flex items-start space-x-2 bg-gray-100 p-2 rounded";
                let commentMenu = '';
                if (comment.uid === currentUserId || postAuthorId === currentUserId) {
                    commentMenu = `<div class="post-menu relative"><span class="text-gray-500 cursor-pointer text-lg">‚ãÆ</span><div class="post-menu-content">`;
                    if (comment.uid === currentUserId) { 
                        commentMenu += `<a onclick="editComment('${postId}', '${commentId}')">Edit</a>`; 
                    }
                    commentMenu += `<a onclick="deleteComment('${postId}', '${commentId}')">Delete</a></div></div>`;
                }
                commentEl.innerHTML = `<div class="text-2xl">${comment.authorEmoji || 'üë§'}</div><div class="flex-1"><div class="flex justify-between items-start"><a href="view_profile.html?uid=${comment.uid}" class="text-sm font-semibold text-green-800 hover:underline">${comment.authorName || 'Anonymous'}</a>${commentMenu}</div><p class="text-gray-700 text-sm comment-text-p">${comment.text}</p></div>`;
                commentsContainer.appendChild(commentEl);
            });
        });
    }
    
    function setupReportButton(postId) {
        const reportBtn = document.getElementById(`report-btn-${postId}`); 
        if (!reportBtn) return;
        db.ref(`posts/${postId}/reportCount`).on('value', countSnapshot => {
            const count = countSnapshot.val() || 0;
            db.ref(`userReports/${postId}/${currentUserId}`).on('value', userSnapshot => {
                const isReportedByUser = userSnapshot.exists();
                if(reportBtn) { 
                    reportBtn.textContent = `${isReportedByUser ? 'Reported' : 'Report'} (${count})`; 
                    reportBtn.classList.toggle('report-btn-reported', isReportedByUser); 
                }
            });
        });
    }
    
    function attachReactionListeners(postKey) {
        document.getElementById(`btnBarakallah-${postKey}`).onclick = () => addReaction(postKey, 'barakallah');
        document.getElementById(`btnSubhanallah-${postKey}`).onclick = () => addReaction(postKey, 'subhanallah');
        document.getElementById(`btnAmeen-${postKey}`).onclick = () => addReaction(postKey, 'ameen');
        db.ref('reactions/' + postKey).on('value', snap => {
            const r = snap.val() || { barakallah: 0, subhanallah: 0, ameen: 0 };
            const btnB = document.querySelector(`#btnBarakallah-${postKey} span:last-child`);
            const btnS = document.querySelector(`#btnSubhanallah-${postKey} span:last-child`);
            const btnA = document.querySelector(`#btnAmeen-${postKey} span:last-child`);
            if (btnB) btnB.textContent = `BarakAllah (${r.barakallah || 0})`; 
            if (btnS) btnS.textContent = `SubhanAllah (${r.subhanallah || 0})`; 
            if (btnA) btnA.textContent = `Ameen (${r.ameen || 0})`;
        });
        db.ref(`userReactions/${postKey}/${currentUserId}`).on('value', snap => {
            const selected = snap.val();
            ['barakallah', 'subhanallah', 'ameen'].forEach(type => {
                const btn = document.getElementById(`btn${capitalize(type)}-${postKey}`);
                if (btn) btn.classList.toggle('reaction-selected', selected === type);
            });
        });
    }
    
    function toggleCommentSection(postId) {
        const wrapper = document.getElementById(`comment-section-wrapper-${postId}`);
        const isLoaded = wrapper.getAttribute('data-loaded') === 'true';
        if (!isLoaded) { 
            loadComments(postId); 
            wrapper.setAttribute('data-loaded', 'true'); 
        }
        wrapper.style.display = (wrapper.style.display === 'none') ? 'block' : 'none';
    }

    function capitalize(str) { 
        return str.charAt(0).toUpperCase() + str.slice(1); 
    }
  </script>
</body>
</html>
