<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MuslimVerse ‚Äì Home</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  
  <style>
    body { scroll-padding-top: 70px; }
    .reaction-btn { cursor: pointer; font-weight: 600; padding: 6px 10px; border-radius: 8px; user-select: none; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; gap: 6px; }
    .reaction-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .reaction-selected { background-color: #a7f3d0; }
    .post-menu { position: relative; display: inline-block; }
    .post-menu-content { display: none; position: absolute; right: 0; background-color: #f9f9f9; min-width: 100px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 6px; }
    .post-menu-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
    .post-menu-content a:hover { background-color: #f1f1f1; }
    .post-menu:hover .post-menu-content { display: block; }
    .report-btn-reported { background-color: #fecaca; color: #991b1b; font-weight: bold; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 30;
        display: none; justify-content: center; align-items: center;
    }
    
    /* Custom Notification Modal Style */
    #notification-modal-content ul { list-style-position: inside; padding-left: 10px; }
    #notification-modal-content li { margin-bottom: 8px; padding-left: 8px; border-left: 3px solid #10b981; }

    /* Floating Menu Styles (Top-Right) */
    .floating-menu-container {
        position: fixed;
        top: 80px; 
        right: 20px;
        z-index: 25;
        display: flex;
        flex-direction: column; 
        align-items: center;
        gap: 14px; 
    }

    .floating-btn {
        width: 56px; height: 56px;
        background-color: #059669;
        color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        border: none;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .floating-btn:hover { background-color: #047857; }
    .floating-menu-toggle { cursor: grab; }

    .floating-menu-item {
        transform: scale(0); 
        opacity: 0;
        visibility: hidden;
        position: absolute; 
    }

    .floating-menu-container.active .floating-menu-item {
        transform: scale(1);
        opacity: 1;
        visibility: visible;
        position: relative; 
    }
    
    .floating-menu-container[style*="column-reverse"] .floating-menu-toggle {
        order: -1;
    }

    #search-results-container { max-height: 300px; overflow-y: auto; }
    
    /* Blinking Animation for Friend Request Icon */
    .blinking-icon {
        animation: blink 1.5s infinite;
        border-radius: 50%; 
    }
    @keyframes blink {
        0% { background-color: #fca5a5; } 
        50% { background-color: #bbf7d0; }
        100% { background-color: #fca5a5; }
    }
    .blinking-icon svg {
        color: #1f2937; 
    }
    
    /* CSS for Ringing Bell Animation */
    @keyframes ring-animation {
        0%, 100% { transform: rotate(0); }
        10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
        20%, 40%, 60%, 80% { transform: rotate(10deg); }
    }

    .ringing-bell {
        animation: ring-animation 1.5s infinite;
    }

    /* CSS for Feed Toggle Buttons */
    .feed-toggle-btn {
        transition: all 0.2s ease-in-out;
        border: 2px solid #059669;
    }
    .feed-toggle-btn.active {
        background-color: #059669;
        color: white;
    }
    .feed-toggle-btn:not(.active) {
        background-color: white;
        color: #059669;
    }

  </style>
</head>
<body class="bg-green-50 min-h-screen text-gray-800">

  <!-- Header -->
  <header class="bg-green-700 text-white shadow-lg sticky top-0 z-20">
    <nav class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="home.html" class="text-xl font-bold flex items-center">
            <span class="mr-2 text-2xl">üïã</span>
            <span>MuslimVerse</span>
        </a>
        <div class="flex items-center space-x-4">
            <a href="requests.html" id="friend-requests-btn" title="Friend Requests" class="p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
            </a>
            <button onclick="checkNotifications()" id="notification-btn" class="text-sm bg-yellow-400 text-black font-semibold px-3 py-1 rounded-md hover:bg-yellow-500 relative">
                Notifications
                <span id="notification-dot" class="absolute top-0 right-0 -mt-1 -mr-1 w-3 h-3 bg-red-500 rounded-full" style="display: none;"></span>
            </button>
        </div>
    </nav>
  </header>

  <!-- Feed Toggle UI -->
  <div class="max-w-xl mx-auto p-4 flex justify-center space-x-2 bg-green-100 sticky top-[68px] z-10">
    <button id="btn-public-feed" onclick="switchFeedMode('public')" class="feed-toggle-btn active w-full py-2 rounded-md font-semibold">
      üåç Public Feed
    </button>
    <button id="btn-friends-feed" onclick="switchFeedMode('friends')" class="feed-toggle-btn w-full py-2 rounded-md font-semibold">
      üë• Friends Feed
    </button>
  </div>

  <!-- Main Content -->
  <main class="max-w-xl mx-auto pt-4">
    <div id="feed" class="space-y-4 px-2 pb-4"></div>
    <div id="load-more-container" class="text-center p-4"></div>
  </main>

  <!-- All Modals -->
  <div id="post-modal-overlay" class="modal-overlay" onclick="toggleModal('post-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('post-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üì¢ What's on your mind?</h2>
          <textarea id="postText" placeholder="Write something Islamic..." class="w-full p-2 border border-gray-300 rounded mb-2"></textarea>
          <input id="postImage" type="text" placeholder="Optional Image URL" class="w-full p-2 border border-gray-300 rounded mb-2" />
          <button onclick="createPost()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">Post Now</button>
      </div>
  </div>
  <div id="search-modal-overlay" class="modal-overlay" onclick="toggleModal('search-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('search-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üîç Find Friends</h2>
          <div class="flex space-x-2 mb-4">
            <input id="searchInput" type="text" placeholder="Enter username..." class="w-full p-2 border border-gray-300 rounded">
            <button onclick="searchUsers()" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded font-semibold">Search</button>
          </div>
          <div id="search-results-container"></div>
      </div>
  </div>
  <div id="share-modal-overlay" class="modal-overlay" onclick="toggleModal('share-modal-overlay', true)">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative" onclick="event.stopPropagation()">
          <button onclick="toggleModal('share-modal-overlay')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">√ó</button>
          <h2 class="text-xl font-semibold mb-4 text-green-700">üîÑ Share Post</h2>
          <textarea id="shareText" placeholder="Add your comment..." class="w-full p-2 border border-gray-300 rounded mb-3"></textarea>
          <div class="mb-4 border-l-4 border-gray-200 pl-3 py-2">
            <h3 class="font-semibold text-sm text-gray-600 mb-2">Original Post:</h3>
            <div id="original-post-preview"></div>
          </div>
          <button onclick="executeShare()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">Share Now</button>
      </div>
  </div>

  <!-- Custom Notification Modal -->
  <div id="notification-modal-overlay" class="modal-overlay" onclick="toggleNotificationModal(false)">
      <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md" onclick="event.stopPropagation()">
          <div class="bg-green-600 text-white p-4 rounded-t-lg flex justify-between items-center">
              <h2 class="text-xl font-semibold">üîî Notifications</h2>
              <button onclick="toggleNotificationModal(false)" class="text-2xl leading-none">√ó</button>
          </div>
          <div id="notification-modal-content" class="p-6 text-gray-700 max-h-80 overflow-y-auto">
              <!-- Notification content will be injected here -->
          </div>
          <div class="bg-gray-100 p-3 rounded-b-lg text-right">
              <button onclick="toggleNotificationModal(false)" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-md">Close</button>
          </div>
      </div>
  </div>

  <!-- Floating Menu Container -->
  <div id="floating-menu-container" class="floating-menu-container">
      <button onclick="toggleActionMenu()" class="floating-btn floating-menu-toggle" title="Menu">
          <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      
      <button onclick="toggleModal('post-modal-overlay')" class="floating-btn floating-action-button floating-menu-item" title="Create Post" style="font-size: 28px;">+</button>
      <a href="message.html" class="floating-btn floating-message-button floating-menu-item" title="Messages" style="font-size: 24px;">üí¨</a>
      <a href="requests.html" class="floating-btn floating-requests-button floating-menu-item" title="Social Hub">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
      </a>
      <button onclick="toggleModal('search-modal-overlay')" class="floating-btn floating-search-button floating-menu-item" title="Search Users">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
      </button>
      <a href="profile.html" class="floating-btn floating-profile-button floating-menu-item" title="My Profile">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
      </a>
      <a href="settings.html" class="floating-btn floating-settings-button floating-menu-item" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
      </a>
  </div>

  <!-- New Friend Request Popup -->
  <div id="friend-request-popup" style="position: fixed; bottom: 85px; right: 20px; background-color: #059669; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; display: none; align-items: center;" onclick="this.style.display='none'; location.href='requests.html'">
      <svg xmlns="http://www.w3.org/2000/svg" class="ringing-bell" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px; margin-right: 10px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <span>New Friend Request</span>
  </div>

  <!-- New Message Popup -->
  <div id="message-popup" style="position: fixed; bottom: 20px; right: 20px; background-color: #059669; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; display: none; align-items: center;" onclick="location.href='message.html'">
      <svg xmlns="http://www.w3.org/2000/svg" class="ringing-bell" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px; margin-right: 10px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <span>New Message</span>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyD3VEv_rdd3FElJupOnfGrBQuLjGwACsA8",
        authDomain: "masklink-calling.firebaseapp.com",
        databaseURL: "https://masklink-calling-default-rtdb.firebaseio.com",
        projectId: "masklink-calling",
        storageBucket: "masklink-calling.appspot.com",
        messagingSenderId: "240213769733",
        appId: "1:240213769733:web:53e35fbf17e4b4d284266c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUserId = null;
    let currentUserProfile = {};
    let postsData = {};
    let hasDragged = false;
    let lastLoadedPostTimestamp = null;
    let isLoading = false;
    const POSTS_PER_PAGE = 10;
    let postToShareId = null;

    // Variables for Feed Control
    let currentFeedMode = 'public'; // 'public' or 'friends'
    let friendsList = [];
    
    // Variables for new request popup
    let initialRequestsLoaded = false;
    let previousRequestCount = 0;


    auth.onAuthStateChanged(user => {
      if (!user) { 
          window.location.href = "login.html"; 
      } else { 
          currentUserId = user.uid; 
          db.ref('userProfiles/' + currentUserId).once('value').then(snap => {
              currentUserProfile = snap.val() || { fullName: user.email, profileEmoji: 'üë§', username: null };
          });
          
          loadFriendsList().then(() => {
              loadPosts(true);
          });
          listenForNotifications();
          listenForFriendRequests();
          listenForUnreadMessages(currentUserId);
          makeMenuDraggable();
      }
    });
    
    // Function to switch between feeds
    function switchFeedMode(mode) {
        if (isLoading || currentFeedMode === mode) return;
        currentFeedMode = mode;
        
        document.getElementById('btn-public-feed').classList.toggle('active', mode === 'public');
        document.getElementById('btn-friends-feed').classList.toggle('active', mode === 'friends');
        
        loadPosts(true);
    }
    
    // Function to load user's friends list
    async function loadFriendsList() {
        friendsList = [];
        const snapshot = await db.ref(`friends/${currentUserId}`).once('value');
        if (snapshot.exists()) {
            snapshot.forEach(child => {
                friendsList.push(child.key);
            });
        }
    }


    function showNewMessagePopup() {
        const popup = document.getElementById('message-popup');
        if (popup) {
            popup.style.display = 'flex';
        }
    }

    function listenForUnreadMessages(userId) {
        const userChatsRef = db.ref(`userChats/${userId}`);
        let initialDataLoaded = false;
        let previousTotalUnread = 0;

        userChatsRef.on('value', snapshot => {
            let totalUnread = 0;
            if (snapshot.exists()) {
                snapshot.forEach(chatSnapshot => {
                    totalUnread += chatSnapshot.val().unreadCount || 0;
                });
            }

            if (initialDataLoaded && totalUnread > previousTotalUnread) {
                showNewMessagePopup();
            }

            previousTotalUnread = totalUnread;
            if (!initialDataLoaded) {
                initialDataLoaded = true;
            }
        });
    }

    function makeMenuDraggable() {
        const menuContainer = document.getElementById('floating-menu-container');
        const dragHandle = document.querySelector('.floating-menu-toggle');
        let isDragging = false, startY, initialTop;

        function dragStart(e) {
            if (e.target !== dragHandle && !dragHandle.contains(e.target)) return;
            e.preventDefault();
            hasDragged = false; isDragging = true;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            initialTop = menuContainer.offsetTop;
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove, { passive: false });
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            dragHandle.style.cursor = 'grabbing';
        }
        function dragMove(e) {
            if (!isDragging) return;
            e.preventDefault(); hasDragged = true;
            const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            let newTop = initialTop + (currentY - startY);
            const topBoundary = 80, bottomBoundary = window.innerHeight / 2;
            if (newTop < topBoundary) newTop = topBoundary;
            if (newTop > bottomBoundary) newTop = bottomBoundary;
            menuContainer.style.top = newTop + 'px';
        }
        function dragEnd() {
            isDragging = false;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchend', dragEnd);
            dragHandle.style.cursor = 'grab';
        }
        dragHandle.addEventListener('mousedown', dragStart);
        dragHandle.addEventListener('touchstart', dragStart, { passive: true });
    }
    
    function toggleActionMenu() {
        if (hasDragged) { hasDragged = false; return; }
        const menuContainer = document.getElementById('floating-menu-container');
        const menuPosition = menuContainer.getBoundingClientRect();
        menuContainer.style.flexDirection = (menuPosition.top > window.innerHeight / 2) ? 'column-reverse' : 'column';
        menuContainer.classList.toggle('active');
        document.getElementById('menu-icon').classList.toggle('hidden');
        document.getElementById('close-icon').classList.toggle('hidden');
    }

    function toggleModal(modalId, closeByOverlay = false) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const isVisible = modal.style.display === 'flex';
        if ((closeByOverlay && event.target === modal) || !closeByOverlay) {
             modal.style.display = isVisible ? 'none' : 'flex';
        }
    }
    
    function toggleNotificationModal(show) {
        const modal = document.getElementById('notification-modal-overlay');
        if (modal) {
            modal.style.display = show ? 'flex' : 'none';
        }
    }

    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const resultsContainer = document.getElementById('search-results-container');
        resultsContainer.innerHTML = '<p class="text-center text-gray-500">Searching...</p>';
        if (!searchTerm) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">Please enter a username.</p>'; return; }
        db.ref('usernames/' + searchTerm).once('value', usernameSnapshot => {
            if (!usernameSnapshot.exists()) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">No user found.</p>'; return; }
            const uid = usernameSnapshot.val().uid;
            if (uid === currentUserId) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">You cannot search for yourself.</p>'; return; }
            db.ref('userProfiles/' + uid).once('value', profileSnapshot => {
                resultsContainer.innerHTML = '';
                const user = profileSnapshot.val();
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center justify-between p-2 my-1 bg-gray-50 rounded-lg';
                userDiv.innerHTML = `<a href="view_profile.html?uid=${uid}" class="flex items-center"><div class="text-3xl w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full mr-3">${user.profileEmoji || 'üë§'}</div><div><span class="font-semibold">${user.fullName || 'Anonymous'}</span><p class="text-xs text-gray-500">@${user.username}</p></div></a><button onclick="sendFriendRequest(this, '${uid}')" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-md hover:bg-blue-600">Add Friend</button>`;
                resultsContainer.appendChild(userDiv);
            });
        });
    }

    function sendFriendRequest(buttonElement, receiverId) {
        db.ref(`friendRequests/${receiverId}/${currentUserId}`).set({ fromName: currentUserProfile.fullName, fromEmoji: currentUserProfile.profileEmoji, timestamp: firebase.database.ServerValue.TIMESTAMP });
        if(buttonElement){
            buttonElement.textContent = 'Request Sent';
            buttonElement.disabled = true;
            buttonElement.className = 'bg-gray-400 text-white text-sm px-3 py-1 rounded-md cursor-not-allowed';
        }
    }

    function createPost() {
        const text = document.getElementById("postText").value.trim();
        const image = document.getElementById("postImage").value.trim();
        if (!text) { alert("Write something first!"); return; }
        if (!currentUserProfile.username) { alert("Your profile is still loading..."); return; }
        const postData = { text, image, uid: currentUserId, authorName: currentUserProfile.fullName, authorEmoji: currentUserProfile.profileEmoji, authorUsername: currentUserProfile.username, timestamp: firebase.database.ServerValue.TIMESTAMP, reportCount: 0, commentCount: 0 };
        const newPostKey = db.ref().child('posts').push().key;
        const updates = {};
        updates['/posts/' + newPostKey] = postData;
        updates['/reactions/' + newPostKey] = { barakallah: 0, subhanallah: 0, ameen: 0 };
        db.ref().update(updates).then(() => {
            document.getElementById("postText").value = "";
            document.getElementById("postImage").value = "";
            toggleModal('post-modal-overlay');
            loadPosts(true); 
        });
    }
    
    function deletePost(postId, isAutoDelete = false) {
        const post = postsData[postId];
        if (!isAutoDelete && post.uid !== currentUserId) { alert("You can only delete your own posts."); return; }
        const confirmation = isAutoDelete ? true : confirm("Are you sure you want to delete this post?");
        if (confirmation) {
            db.ref('posts/' + postId).remove(); db.ref('reactions/' + postId).remove();
            db.ref('userReactions/' + postId).remove(); db.ref('comments/' + postId).remove();
            db.ref('userReports/' + postId).remove();
            const postElement = document.getElementById(`post-${postId}`);
            if(postElement) postElement.remove();
        }
    }

    function editPost(postId) {
        const postToEdit = postsData[postId];
        if (!postToEdit || postToEdit.uid !== currentUserId) { alert("Error: Post not found or you don't have permission."); return; }
        const newText = prompt("Edit your post:", postToEdit.text);
        const newImage = prompt("Edit your image URL:", postToEdit.image || '');
        if (newText !== null && newText.trim() !== '') {
            db.ref('posts/' + postId).update({ text: newText.trim(), image: newImage ? newImage.trim() : null }).then(() => {
               document.querySelector(`#post-${postId} .post-text`).textContent = newText.trim();
               const imgEl = document.querySelector(`#post-${postId} .post-image`);
               if(newImage && newImage.trim() !== '') { imgEl.src = newImage.trim(); imgEl.style.display = 'block'; } 
               else if (imgEl) { imgEl.style.display = 'none'; }
            });
        }
    }
    
    function openShareModal(postId) {
        postToShareId = postId;
        const post = postsData[postId];
        if (!post) return;
        
        const previewContainer = document.getElementById('original-post-preview');
        previewContainer.innerHTML = `
            <div class="flex items-center mb-2">
                <div class="text-2xl w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full mr-2">${post.authorEmoji || 'üë§'}</div>
                <span class="font-semibold text-gray-800">${post.authorName || 'Anonymous'}</span>
            </div>
            <p class="text-gray-600 text-sm whitespace-pre-wrap">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>
            ${post.image ? `<img src="${post.image}" class="mt-2 rounded max-h-24 object-contain w-full" />` : ""}
        `;
        
        toggleModal('share-modal-overlay');
    }

    function executeShare() {
        const shareText = document.getElementById('shareText').value.trim();
        const originalPost = postsData[postToShareId];

        if (!shareText) { alert("Please add your comment before sharing."); return; }
        if (!originalPost) { alert("Error: Original post not found."); return; }

        const postData = {
            text: shareText,
            uid: currentUserId,
            authorName: currentUserProfile.fullName,
            authorEmoji: currentUserProfile.profileEmoji,
            authorUsername: currentUserProfile.username,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            reportCount: 0,
            commentCount: 0,
            originalPost: {
                key: originalPost.key,
                text: originalPost.text,
                image: originalPost.image || null,
                uid: originalPost.uid,
                authorName: originalPost.authorName,
                authorEmoji: originalPost.authorEmoji,
                authorUsername: originalPost.authorUsername
            }
        };
        
        const newPostKey = db.ref().child('posts').push().key;
        const updates = {};
        updates['/posts/' + newPostKey] = postData;
        updates['/reactions/' + newPostKey] = { barakallah: 0, subhanallah: 0, ameen: 0 };
        db.ref().update(updates).then(() => {
            document.getElementById("shareText").value = "";
            toggleModal('share-modal-overlay');
            loadPosts(true); 
            sendNotification(originalPost.uid, `${currentUserProfile.fullName} shared your post.`);
        });
    }

    function sendNotification(targetUserId, message) {
        if (targetUserId === currentUserId) return;
        db.ref('notifications/' + targetUserId).push({ message, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false });
    }
    
    function listenForNotifications() {
        const notificationsRef = db.ref('notifications/' + currentUserId);
        notificationsRef.orderByChild('read').equalTo(false).on('value', snapshot => {
            document.getElementById('notification-dot').style.display = snapshot.exists() ? 'block' : 'none';
        });
    }
    
    function showNewFriendPopup() {
        const popup = document.getElementById('friend-request-popup');
        if (popup) {
            popup.style.display = 'flex';
        }
    }

    function listenForFriendRequests() {
        const requestsRef = db.ref(`friendRequests/${currentUserId}`);
        const friendRequestsBtn = document.getElementById('friend-requests-btn');
        if (!friendRequestsBtn) return;
        
        requestsRef.on('value', snapshot => {
            const currentRequestCount = snapshot.numChildren();
            friendRequestsBtn.classList.toggle('blinking-icon', currentRequestCount > 0);

            if (initialRequestsLoaded && currentRequestCount > previousRequestCount) {
                showNewFriendPopup();
            }

            previousRequestCount = currentRequestCount;
            if (!initialRequestsLoaded) {
                initialRequestsLoaded = true;
            }
        });
    }

    function checkNotifications() {
        const notificationsRef = db.ref('notifications/' + currentUserId);
        const modalContent = document.getElementById('notification-modal-content');
        
        notificationsRef.once('value').then(snapshot => {
            if (!snapshot.exists()) {
                modalContent.innerHTML = '<p class="text-center">You have no new notifications.</p>';
            } else {
                let messagesHtml = '<ul>';
                const updates = {};
                snapshot.forEach(child => {
                    messagesHtml += `<li>${child.val().message}</li>`;
                    updates[child.key + "/read"] = true;
                });
                messagesHtml += '</ul>';
                modalContent.innerHTML = messagesHtml;
                notificationsRef.update(updates);
            }
            toggleNotificationModal(true);
        });
    }

    function toggleReportPost(postId, authorId) {
        const reportBtn = document.getElementById(`report-btn-${postId}`);
        if (reportBtn.disabled) return; reportBtn.disabled = true;
        const userReportRef = db.ref(`userReports/${postId}/${currentUserId}`);
        const postReportCountRef = db.ref(`posts/${postId}/reportCount`);
        userReportRef.once('value').then(snapshot => {
            if (snapshot.exists()) {
                postReportCountRef.transaction(c => (c && c > 0) ? c - 1 : 0);
                userReportRef.remove().finally(() => reportBtn.disabled = false);
            } else {
                userReportRef.set(true).then(() => {
                    postReportCountRef.transaction((c) => (c || 0) + 1, (err, committed, snap) => {
                        if (committed) {
                            const newCount = snap.val();
                            if (newCount === 5) sendNotification(authorId, "Warning: Your post has 5 reports.");
                            else if (newCount >= 10) { sendNotification(authorId, `Your post was auto-deleted after receiving ${newCount} reports.`); deletePost(postId, true); }
                        }
                        reportBtn.disabled = false;
                    });
                });
            }
        });
    }

    function addComment(postId, postAuthorId) {
        const text = document.getElementById(`comment-input-${postId}`).value.trim();
        if (!text) return;
        const commentData = { text, uid: currentUserId, authorName: currentUserProfile.fullName, authorEmoji: currentUserProfile.profileEmoji, timestamp: firebase.database.ServerValue.TIMESTAMP };
        db.ref('comments/' + postId).push(commentData).then(() => {
            document.getElementById(`comment-input-${postId}`).value = "";
            sendNotification(postAuthorId, `${currentUserProfile.fullName} commented on your post.`);
            db.ref(`posts/${postId}/commentCount`).transaction(count => (count || 0) + 1);
        });
    }

    function editComment(postId, commentId) {
        const commentRef = db.ref(`comments/${postId}/${commentId}`);
        commentRef.once('value', snapshot => {
            const comment = snapshot.val();
            if (!comment || comment.uid !== currentUserId) {
                alert("You can only edit your own comments.");
                return;
            }
            const newText = prompt("Edit your comment:", comment.text);
            if (newText !== null && newText.trim() !== "") {
                commentRef.update({ text: newText.trim() })
                    .catch(err => alert("Error editing comment: " + err.message));
            }
        });
    }
    
    function deleteComment(postId, commentId) {
        const postAuthorId = postsData[postId]?.uid;
        if (!postAuthorId) { alert("Error: Post not found."); return; }
        db.ref(`comments/${postId}/${commentId}`).once('value', commentSnap => {
            const comment = commentSnap.val();
            if (!comment) return;
            if (comment.uid === currentUserId || postAuthorId === currentUserId) {
                 if (confirm("Are you sure you want to delete this comment?")) {
                    db.ref(`comments/${postId}/${commentId}`).remove().then(() => {
                        db.ref(`posts/${postId}/commentCount`).transaction(count => (count && count > 0) ? count - 1 : 0);
                    }).catch(err => alert("Error deleting comment: " + err.message));
                 }
            } else {
                alert("You don't have permission to delete this comment.");
            }
        });
    }
    
    function addReaction(postId, reactionType) {
        const buttons = [ document.getElementById(`btnBarakallah-${postId}`), document.getElementById(`btnSubhanallah-${postId}`), document.getElementById(`btnAmeen-${postId}`) ];
        if (buttons.some(b => b && b.disabled)) return;
        buttons.forEach(b => { if (b) b.disabled = true; });
        const userReactionRef = db.ref(`userReactions/${postId}/${currentUserId}`), reactionsRef = db.ref(`reactions/${postId}`);
        userReactionRef.once('value').then(snapshot => {
            const previousReaction = snapshot.val(), updates = {};
            if (previousReaction === reactionType) {
                userReactionRef.remove();
                reactionsRef.child(reactionType).transaction(c => (c || 1) - 1).finally(() => buttons.forEach(b => b.disabled=false));
            } else {
                if (previousReaction) updates[`reactions/${postId}/${previousReaction}`] = firebase.database.ServerValue.increment(-1);
                updates[`reactions/${postId}/${reactionType}`] = firebase.database.ServerValue.increment(1);
                updates[`userReactions/${postId}/${currentUserId}`] = reactionType;
                db.ref().update(updates).then(() => {
                    db.ref(`posts/${postId}/uid`).once('value', authorSnap => sendNotification(authorSnap.val(), `${currentUserProfile.fullName} reacted to your post.`));
                }).finally(() => buttons.forEach(b => b.disabled=false));
            }
        });
    }
    
    // The core loadPosts function is now feed-aware
    function loadPosts(isInitialLoad = false) {
        if (isLoading) return; 
        isLoading = true;
        const feed = document.getElementById("feed");
        const loadMoreContainer = document.getElementById("load-more-container");

        if (isInitialLoad) { 
            feed.innerHTML = ""; 
            postsData = {}; 
            lastLoadedPostTimestamp = null; 
        }

        loadMoreContainer.innerHTML = `<p class="text-gray-500">Loading ${currentFeedMode} posts...</p>`;
        
        let query = db.ref("posts").orderByChild("timestamp");
        if (lastLoadedPostTimestamp) {
            query = query.endAt(lastLoadedPostTimestamp - 1).limitToLast(POSTS_PER_PAGE);
        } else {
            query = query.limitToLast(POSTS_PER_PAGE);
        }
        
        query.once("value", snapshot => {
            loadMoreContainer.innerHTML = "";
            if (!snapshot.exists()) {
                if(isInitialLoad || feed.innerHTML === "") {
                    feed.innerHTML = `<p class="text-center text-gray-500 py-10">No posts to show in the ${currentFeedMode} feed.</p>`;
                } else {
                    loadMoreContainer.innerHTML = '<p class="text-gray-500">You have reached the end.</p>';
                }
                isLoading = false; 
                return; 
            }
            
            const posts = [];
            snapshot.forEach(child => { 
                const post = { key: child.key, ...child.val() }; 
                if (!postsData[post.key]) { 
                    posts.unshift(post); 
                    postsData[post.key] = post; 
                } 
            });

            if (posts.length > 0) {
                lastLoadedPostTimestamp = posts[posts.length - 1].timestamp;
            }

            const filteredPosts = (currentFeedMode === 'friends')
                ? posts.filter(post => friendsList.includes(post.uid) || post.uid === currentUserId)
                : posts;

            if (filteredPosts.length === 0 && snapshot.numChildren() > 0) {
                isLoading = false;
                loadPosts(false);
                return;
            }

            filteredPosts.forEach(post => {
                if (!post.authorUsername) return;
                const postEl = document.createElement("div"); 
                postEl.id = `post-${post.key}`; 
                postEl.className = "bg-white p-4 rounded-lg shadow";
                const time = new Date(post.timestamp).toLocaleString();
                let menuHtml = (post.uid === currentUserId) ? `<div class="post-menu float-right relative"><span class="text-gray-500 cursor-pointer text-lg">‚ãÆ</span><div class="post-menu-content"><a onclick="editPost('${post.key}')">Edit</a><a onclick="deletePost('${post.key}')">Delete</a></div></div>` : '';
                let warningBannerHtml = (post.reportCount >= 5) ? `<div class="p-2 my-3 bg-red-100 border-l-4 border-red-500 text-red-700"><p class="font-bold">Warning:</p><p>This post is under review.</p></div>` : '';
                
                let originalPostHtml = '';
                if (post.originalPost) {
                    originalPostHtml = `
                        <div class="mt-4 border-l-4 border-green-200 pl-3 pt-2 pb-3">
                            <div class="flex items-center mb-2">
                                <div class="text-2xl w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full mr-2">${post.originalPost.authorEmoji || 'üë§'}</div>
                                <div><a href="view_profile.html?uid=${post.originalPost.uid}" class="text-sm text-green-700 font-bold hover:underline">${post.originalPost.authorName || 'Anonymous'}</a></div>
                            </div>
                            <p class="text-gray-700 text-sm whitespace-pre-wrap">${post.originalPost.text}</p>
                            ${post.originalPost.image ? `<img src="${post.originalPost.image}" class="mt-2 rounded max-h-80 object-contain w-full" />` : ""}
                        </div>`;
                }
                
                postEl.innerHTML = `<div class="flex justify-between items-start"><div class="flex items-center mb-3"><div class="text-4xl w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full mr-3">${post.authorEmoji || 'üë§'}</div><div><a href="view_profile.html?uid=${post.uid}" class="text-md text-green-700 font-bold hover:underline">${post.authorName || 'Anonymous'}</a><p class="text-xs text-gray-500">${time}</p></div></div>${menuHtml}</div>${warningBannerHtml}<p class="text-gray-800 mt-1 whitespace-pre-wrap post-text">${post.text}</p>${post.image ? `<img src="${post.image}" class="mt-2 rounded max-h-96 object-contain w-full post-image" />` : ""}${originalPostHtml}<div id="reactions-${post.key}" class="flex justify-around items-center mt-4 pt-3 text-sm border-t"><button id="btnBarakallah-${post.key}" class="reaction-btn text-red-600"><span>‚ù§Ô∏è</span><span>BarakAllah (0)</span></button><button id="btnSubhanallah-${post.key}" class="reaction-btn text-yellow-600"><span>üåü</span><span>SubhanAllah (0)</span></button><button id="btnAmeen-${post.key}" class="reaction-btn text-green-600"><span>üôå</span><span>Ameen (0)</span></button></div><div class="border-t mt-3 pt-3 flex justify-between items-center"><button id="toggle-comments-btn-${post.key}" onclick="toggleCommentSection('${post.key}')" class="text-sm font-semibold text-gray-600 hover:text-green-700">üí¨ Comments (${post.commentCount || 0})</button><button onclick="openShareModal('${post.key}')" class="text-sm font-semibold text-gray-600 hover:text-green-700">üîÑ Share</button><button id="report-btn-${post.key}" onclick="toggleReportPost('${post.key}', '${post.uid}')" class="reaction-btn text-xs bg-red-50 hover:bg-red-100 text-red-700">Report (0)</button></div><div id="comment-section-wrapper-${post.key}" data-loaded="false" class="mt-3" style="display: none;"><div id="comments-container-${post.key}" class="space-y-2 mb-3 max-h-40 overflow-y-auto"></div><div class="flex space-x-2"><input id="comment-input-${post.key}" type="text" placeholder="Write a comment..." class="w-full p-2 border border-gray-300 rounded"><button onclick="addComment('${post.key}', '${post.uid}')" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded font-semibold">Send</button></div></div>`;
                feed.appendChild(postEl);
                attachReactionListeners(post.key); 
                setupReportButton(post.key);
                db.ref(`posts/${post.key}/commentCount`).on('value', snap => { const btn = document.getElementById(`toggle-comments-btn-${post.key}`); if(btn) btn.textContent = `üí¨ Comments (${snap.val() || 0})`; });
            });

            if (posts.length >= POSTS_PER_PAGE) { 
                const loadMoreBtn = document.createElement('button'); 
                loadMoreBtn.textContent = 'Load More'; 
                loadMoreBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full'; 
                loadMoreBtn.onclick = () => loadPosts(false);
                loadMoreContainer.appendChild(loadMoreBtn); 
            } else {
                if (isInitialLoad && filteredPosts.length === 0) {
                     feed.innerHTML = `<p class="text-center text-gray-500 py-10">No posts to show in the ${currentFeedMode} feed.</p>`;
                } else if (!isInitialLoad) {
                     loadMoreContainer.innerHTML = '<p class="text-gray-500">You have reached the end.</p>'; 
                }
            }
            isLoading = false;
        });
    }

    function loadComments(postId) {
        const commentsContainer = document.getElementById(`comments-container-${postId}`); if (!commentsContainer) return;
        const postAuthorId = postsData[postId]?.uid;
        commentsContainer.innerHTML = '<p class="text-sm text-gray-500">Loading comments...</p>';
        const commentsRef = db.ref('comments/' + postId).orderByChild('timestamp');
        commentsRef.on('value', snapshot => {
            if (!commentsContainer) return; commentsContainer.innerHTML = "";
            if(!snapshot.exists()) { commentsContainer.innerHTML = '<p class="text-sm text-gray-500">Be the first to comment!</p>'; }
            snapshot.forEach(childSnapshot => {
                const comment = childSnapshot.val(), commentId = childSnapshot.key, commentEl = document.createElement('div');
                commentEl.id = `comment-${commentId}`; // Add an ID to the comment element
                commentEl.className = "flex items-start space-x-2 bg-gray-100 p-2 rounded";
                let commentMenu = '';
                if (comment.uid === currentUserId || postAuthorId === currentUserId) {
                    commentMenu = `<div class="post-menu relative"><span class="text-gray-500 cursor-pointer text-lg">‚ãÆ</span><div class="post-menu-content">`;
                    if (comment.uid === currentUserId) { 
                        commentMenu += `<a onclick="editComment('${postId}', '${commentId}')">Edit</a>`;
                    }
                    commentMenu += `<a onclick="deleteComment('${postId}', '${commentId}')">Delete</a></div></div>`;
                }

                commentEl.innerHTML = `<div class="text-2xl">${comment.authorEmoji || 'üë§'}</div><div class="flex-1"><div class="flex justify-between items-start"><a href="view_profile.html?uid=${comment.uid}" class="text-sm font-semibold text-green-800 hover:underline">${comment.authorName || 'Anonymous'}</a>${commentMenu}</div><p class="text-gray-700 text-sm comment-text-p">${comment.text}</p></div>`;
                commentsContainer.appendChild(commentEl);
            });
        });
    }
    
    function setupReportButton(postId) {
        const reportBtn = document.getElementById(`report-btn-${postId}`); if (!reportBtn) return;
        db.ref(`posts/${postId}/reportCount`).on('value', countSnapshot => {
            const count = countSnapshot.val() || 0;
            db.ref(`userReports/${postId}/${currentUserId}`).on('value', userSnapshot => {
                const isReportedByUser = userSnapshot.exists();
                if(reportBtn) { reportBtn.textContent = `${isReportedByUser ? 'Reported' : 'Report'} (${count})`; reportBtn.classList.toggle('report-btn-reported', isReportedByUser); }
            });
        });
    }
    
    function attachReactionListeners(postKey) {
        document.getElementById(`btnBarakallah-${postKey}`).onclick = () => addReaction(postKey, 'barakallah');
        document.getElementById(`btnSubhanallah-${postKey}`).onclick = () => addReaction(postKey, 'subhanallah');
        document.getElementById(`btnAmeen-${postKey}`).onclick = () => addReaction(postKey, 'ameen');
        db.ref('reactions/' + postKey).on('value', snap => {
            const r = snap.val() || { barakallah: 0, subhanallah: 0, ameen: 0 };
            const btnB = document.querySelector(`#btnBarakallah-${postKey} span:last-child`), btnS = document.querySelector(`#btnSubhanallah-${postKey} span:last-child`), btnA = document.querySelector(`#btnAmeen-${postKey} span:last-child`);
            if (btnB) btnB.textContent = `BarakAllah (${r.barakallah || 0})`; if (btnS) btnS.textContent = `SubhanAllah (${r.subhanallah || 0})`; if (btnA) btnA.textContent = `Ameen (${r.ameen || 0})`;
        });
        db.ref(`userReactions/${postKey}/${currentUserId}`).on('value', snap => {
            const selected = snap.val();
            ['barakallah', 'subhanallah', 'ameen'].forEach(type => {
                const btn = document.getElementById(`btn${capitalize(type)}-${postKey}`);
                if (btn) btn.classList.toggle('reaction-selected', selected === type);
            });
        });
    }
    
    function toggleCommentSection(postId) {
        const wrapper = document.getElementById(`comment-section-wrapper-${postId}`);
        const isLoaded = wrapper.getAttribute('data-loaded') === 'true';
        if (!isLoaded) { loadComments(postId); wrapper.setAttribute('data-loaded', 'true'); }
        wrapper.style.display = (wrapper.style.display === 'none') ? 'block' : 'none';
    }

    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
  </script>
</body>
  </html>
